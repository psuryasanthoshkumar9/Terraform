image:
  name: hashicorp/terraform:1.5.7
  entrypoint: [""]

variables:
  TF_ROOT: "Day-1-basic-code"

stages:
  - choose
  - init
  - action

# ----------------------------------------------------
# 1️⃣ User chooses APPLY or DESTROY
# ----------------------------------------------------
choose_action:
  stage: choose
  script:
    - echo "❗ Please provide ACTION variable while running pipeline."
    - echo "➡ ACTION=apply   (to create resources)"
    - echo "➡ ACTION=destroy (to delete resources)"
    - echo ""
    - echo "Go to: CI/CD → Run Pipeline → Add variable ACTION"
    - exit 1
  when: manual
  allow_failure: false

# ----------------------------------------------------
# 2️⃣ Terraform INIT (runs for both apply/destroy)
# ----------------------------------------------------
terraform_init:
  stage: init
  script:
    - cd $TF_ROOT
    - terraform init
  rules:
    - if: '$ACTION == "apply"'
    - if: '$ACTION == "destroy"'

# ----------------------------------------------------
# 3️⃣ Terraform APPLY
# ----------------------------------------------------
terraform_apply:
  stage: action
  script:
    - cd $TF_ROOT
    - terraform plan
    - terraform apply -auto-approve
  rules:
    - if: '$ACTION == "apply"'

# ----------------------------------------------------
# 4️⃣ Terraform DESTROY
# ----------------------------------------------------
terraform_destroy:
  stage: action
  script:
    - cd $TF_ROOT
    - terraform plan -destroy
    - terraform destroy -auto-approve
  rules:
    - if: '$ACTION == "destroy"'
